@startuml
hide empty description


state MAPPING: update workspace
MAPPING: collision check
MAPPING-->MAPPING

state PLANNING: wait call
PLANNING: plan
PLANNING: publish trajectory
PLANNING-->PLANNING


state MANAGER: check inputs right, otherwise return
state MANAGER: do the following tasks
state MANAGER: check armming state. if disarmming, clear and return
state MANAGER: check flight mode. if non-OFFBOARD, clear and return
state MANAGER: if enter OFFBOARD, preprocess waypoints once and global planninng
state MANAGER: check if arriving  target
state MANAGER: call plan
state MANAGER: call replan
state MANAGER: execute

state MANAGER{

    state READY: on land
    READY: set home

    state MANUALFLIGHT: flight under non-OFFBOARD
    ' MANUALFLIGHT: if enter OFFBOARD, preprocess waypoints

    state AUTOFLIGHT: if enter OFFBOARD, preprocess waypoints once and global planninng
    AUTOFLIGHT: check if arriving  target
    AUTOFLIGHT: send cmds
    state AUTOFLIGHT{
        state GEN_NEW_TRAJ: chose target
        GEN_NEW_TRAJ: get start state from current state
        GEN_NEW_TRAJ: get local target state
        GEN_NEW_TRAJ: call replan via sending start and target state

        state REPLAN_TRAJ: chose target
        REPLAN_TRAJ: get start state from trajectory
        REPLAN_TRAJ: set local target state
        REPLAN_TRAJ: call replan via sending start and target state

        state EXEC_TRAJ: check if need replan and reach end
        EXEC_TRAJ: send cmds

        state WAIT_TRAJ: wait target
        WAIT_TRAJ: if from GEN_NEW_TRAJ, send zero
        WAIT_TRAJ: if from REPLAN_TRAJ, send cmds from planned trajectory

        [*]-[#green,bold]-->GEN_NEW_TRAJ
        [*]-[#red,bold]-->REPLAN_TRAJ: collision

        GEN_NEW_TRAJ-[#green,bold]->WAIT_TRAJ
        WAIT_TRAJ-[#green,bold]->GEN_NEW_TRAJ: plan failed

        WAIT_TRAJ-[#green,bold]->EXEC_TRAJ: receive traj
        EXEC_TRAJ-[#green,bold]->REPLAN_TRAJ: over duration/distance

        REPLAN_TRAJ-[#green,bold]->WAIT_TRAJ

        EXEC_TRAJ-[#green,bold]->[*]: reach end
    }

    state FAULT: empty

    ' [*] -[#green,bold]-> IDLE: initialization
    [*]-->READY
    READY --> MANUALFLIGHT: armming
    MANUALFLIGHT-->READY: disarmming
    ' MANUALFLIGHT --> MANUALFLIGHT
    MANUALFLIGHT --> AUTOFLIGHT: OFFBOARD
    AUTOFLIGHT --> MANUALFLIGHT: non-OFFBOARD
    AUTOFLIGHT --> READY: disarmming

}

state fork_state <<fork>>
[*]-->fork_state
fork_state-[#green,bold]->MANAGER
fork_state-[#green,bold]->MAPPING
fork_state-[#green,bold]->PLANNING





@enduml